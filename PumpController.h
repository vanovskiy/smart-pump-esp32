// файл: PumpController.h
// Заголовочный файл класса для управления исполнительными устройствами помпы
// Отвечает за: реле помпы, реле питания чайника, сервопривод, зуммер

#ifndef PUMP_CONTROLLER_H
#define PUMP_CONTROLLER_H

#include "config.h"
#include <ESP32Servo.h> // Специализированная библиотека для работы с серво на ESP32

/**
 * Класс PumpController объединяет управление всеми исполнительными устройствами:
 * - Реле помпы (включение/выключение подачи воды)
 * - Реле питания чайника (автоматическое включение при достаточном уровне воды)
 * - Сервопривод (перемещение трубки налива над чайником)
 * - Зуммер (звуковая индикация событий)
 * 
 * Обеспечивает защиту от частых переключений реле (cooldown) и
 * отслеживание состояния движения сервопривода.
 */
class PumpController {
  private:
    // ==================== СЕРВОПРИВОД ====================
    Servo servo;                          // Объект сервопривода из библиотеки ESP32Servo
    ServoState currentServoState;          // Текущее состояние серво (SERVO_IDLE, MOVING, OVER_KETTLE)
    ServoState targetServoState;           // Целевое состояние после завершения движения
    unsigned long servoMoveStartTime;      // Время начала движения серво (для отслеживания длительности)
    
    // ==================== РЕЛЕ ====================
    bool pumpRelayState;                   // Состояние реле помпы (true = включено)
    bool powerRelayState;                   // Состояние реле питания чайника (true = включено)
    unsigned long lastPowerRelayToggleTime; // Время последнего переключения реле питания
                                           // Используется для защиты от частых переключений

  public:
    // ==================== КОНСТРУКТОР ====================
    /**
     * Конструктор, инициализирует все переменные начальными значениями
     */
    PumpController();

    // ==================== ИНИЦИАЛИЗАЦИЯ ====================
    /**
     * Настраивает пины, устанавливает начальные состояния реле,
     * подключает серво и переводит его в безопасную позицию
     * Должен вызываться один раз в setup()
     */
    void begin();
    
    /**
     * Обновляет состояние сервопривода (проверяет, закончилось ли движение)
     * Должен вызываться каждый цикл loop()
     */
    void update();

    // ==================== УПРАВЛЕНИЕ ПОМПОЙ ====================
    /** Включить реле помпы (начать подачу воды) */
    void pumpOn();
    
    /** Выключить реле помпы (остановить подачу воды) */
    void pumpOff();
    
    /** Проверить, включена ли помпа */
    bool isPumpOn();

    // ==================== УПРАВЛЕНИЕ ПИТАНИЕМ ЧАЙНИКА ====================
    /** Включить реле питания чайника (с учетом защиты от частых переключений) */
    void powerOn();
    
    /** Выключить реле питания чайника (с учетом защиты от частых переключений) */
    void powerOff();
    
    /**
     * Установить состояние реле питания (включено/выключено)
     * @param state - true для включения, false для выключения
     */
    void setPowerRelay(bool state);
    
    /**
     * Проверить, можно ли переключать реле питания (прошло ли достаточно времени)
     * @return true - можно переключать, false - еще рано (cooldown)
     */
    bool canTogglePowerRelay();
    
    /** Получить текущее состояние реле питания */
    bool isPowerRelayOn() { return powerRelayState; }

    // ==================== УПРАВЛЕНИЕ СЕРВОПРИВОДОМ ====================
    /** Переместить трубку налива в позицию над чайником (угол 90°) */
    void moveServoToKettle();
    
    /** Переместить трубку налива в безопасную позицию (угол 0°) */
    void moveServoToIdle();
    
    /**
     * Экстренная остановка: выключить помпу и вернуть трубку в безопасную позицию
     * Используется при ошибках или команде STOP
     */
    void emergencyStop();
    
    /**
     * Проверить, достиг ли сервопривод целевой позиции
     * @return true - серво на месте и не движется
     */
    bool isServoInPosition();
    
    /** Получить текущее состояние сервопривода */
    ServoState getServoState();

    // ==================== УПРАВЛЕНИЕ ЗУММЕРОМ ====================
    /**
     * Подать короткие звуковые сигналы
     * @param count - количество сигналов (по умолчанию 1)
     */
    void beepShort(int count = 1);
    
    /**
     * Подать длинные звуковые сигналы
     * @param count - количество сигналов (по умолчанию 1)
     */
    void beepLong(int count = 1);
    
    /**
     * Специальный цикл звуковой индикации для режима ошибки
     * 3 длинных + 1 короткий сигнал каждые 5 секунд
     * Должен вызываться из loop() при нахождении в состоянии ошибки
     */
    void errorBeepLoop();
};

#endif