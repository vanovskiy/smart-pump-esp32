// файл: Scale.h
// Заголовочный файл класса для работы с тензодатчиком HX711
// Отвечает за измерение веса, калибровку, фильтрацию и хранение данных

#ifndef SCALE_H
#define SCALE_H

#include "config.h"
#include <GyverHX711.h>

/**
 * Класс Scale управляет тензодатчиком HX711
 * Предоставляет функции для:
 * - Измерения текущего веса с фильтрацией
 * - Калибровки веса пустого чайника
 * - Сохранения/загрузки калибровочных данных в EEPROM
 * - Определения наличия чайника на весах
 * - Проверки стабильности измерений
 */
class Scale {
  private:
    // ==================== ОСНОВНЫЕ ПЕРЕМЕННЫЕ ====================
    GyverHX711 scale;                    // Объект для работы с HX711 (из библиотеки GyverHX711)
    
    float emptyWeight;                    // Вес пустого чайника в граммах (калибруется пользователем)
    float currentWeight;                  // Текущий отфильтрованный вес (сглаженный)
    float calibrationFactor;              // Коэффициент преобразования сырых показаний в граммы
                                         // По умолчанию 0.42, требуется точная настройка
    
    // ==================== ДЛЯ ПРОВЕРКИ СТАБИЛЬНОСТИ ====================
    float lastReadWeight;                 // Последнее прочитанное значение (для отслеживания изменений)
    unsigned long lastStableReadTime;      // Время, когда вес был стабильным
    
    // ==================== ДЛЯ ФИЛЬТРАЦИИ (СКОЛЬЗЯЩЕЕ СРЕДНЕЕ) ====================
    static const int STABLE_READINGS = 5;  // Количество измерений для усреднения
    float readings[STABLE_READINGS];       // Кольцевой буфер для хранения последних измерений
    int readIndex;                          // Текущий индекс в кольцевом буфере
    
    // ==================== ДЛЯ РАБОТЫ С EEPROM ====================
    bool isCalibrated;                      // Флаг: откалиброван ли датчик (есть сохраненные данные)
    int eepromAddr;                         // Адрес в EEPROM, где хранятся данные калибровки

  public:
    // ==================== КОНСТРУКТОР ====================
    /**
     * Конструктор, инициализирует переменные начальными значениями
     * Устанавливает calibrationFactor = 0.42f по умолчанию
     */
    Scale();

    // ==================== ИНИЦИАЛИЗАЦИЯ ====================
    /**
     * Запускает датчик, выполняет тарирование (обнуление)
     * @return true - датчик успешно инициализирован
     */
    bool begin();
    
    /**
     * Выполняет тарирование (обнуление) весов
     * Устанавливает текущий вес как нулевую точку
     */
    void tare();

    // ==================== КАЛИБРОВКА ====================
    /**
     * Устанавливает вес пустого чайника (калибровка)
     * @param weight - измеренный вес пустого чайника
     */
    void calibrateEmpty(float weight);
    
    /**
     * Устанавливает коэффициент калибровки датчика
     * @param factor - новый коэффициент (обычно в диапазоне 0.0001-0.001)
     */
    void setCalibrationFactor(float factor);
    
    /**
     * Сохраняет данные калибровки (emptyWeight и calibrationFactor) в EEPROM
     * @param addr - начальный адрес в EEPROM (должен быть кратен 4)
     */
    void saveCalibrationToEEPROM(int addr);
    
    /**
     * Загружает данные калибровки из EEPROM
     * Если данные не найдены, устанавливает isCalibrated = false
     * @param addr - начальный адрес в EEPROM
     */
    void loadCalibrationFromEEPROM(int addr);
    
    /**
     * Сбрасывает калибровку: очищает флаг isCalibrated и стирает данные в EEPROM
     */
    void resetCalibration();

    // ==================== ГЕТТЕРЫ ====================
    /** @return вес пустого чайника в граммах */
    float getEmptyWeight();
    
    /** @return текущий отфильтрованный вес в граммах */
    float getCurrentWeight();
    
    /** @return сырой (нефильтрованный) вес в граммах */
    float getRawWeight();

    // ==================== ПРОВЕРКИ СОСТОЯНИЯ ====================
    /**
     * Обновляет текущий вес новым измерением
     * Выполняет фильтрацию (скользящее среднее) и защиту от выбросов
     * Должен вызываться каждый цикл loop()
     * 
     * @return true - измерение успешно обновлено
     */
    bool update();
    
    /**
     * Проверяет готовность весов к работе
     * @return true - датчик откалиброван и отвечает
     */
    bool isReady();
    
    /**
     * Проверяет, стоит ли чайник на весах
     * Учитывает гистерезис для предотвращения ложных срабатываний
     * @return true - чайник на месте
     */
    bool isKettlePresent();
    
    /**
     * Проверяет, стабилен ли текущий вес
     * Используется для детекции отсутствия потока воды
     * @return true - вес не меняется длительное время
     */
    bool isWeightStable();
};

#endif