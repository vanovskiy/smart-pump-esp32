<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–º–ø—ã</title>
    <style>
        body { font-family: Arial; text-align: center; margin-top: 50px; background: #f0f0f0; }
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; font-size: 24px; }
        h2 { color: #666; font-size: 18px; margin-top: 20px; }
        label { display: block; margin: 20px 0 5px; text-align: left; color: #666; }
        select, input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        button { background: #4CAF50; color: white; border: none; padding: 15px; font-size: 18px; border-radius: 5px; cursor: pointer; width: 100%; }
        button:hover { background: #45a049; }
        .scan-btn { background: #2196F3; margin-bottom: 20px; }
        .scan-btn:hover { background: #0b7dda; }
        .section { background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .info { color: #666; margin: 10px 0; font-size: 14px; }
        #status { margin-top: 20px; padding: 10px; border-radius: 5px; display: none; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .note { color: #888; font-size: 12px; text-align: left; margin-top: -15px; margin-bottom: 20px; }
    </style>
    <script>
        function scanNetworks() {
            document.getElementById('status').style.display = 'block';
            document.getElementById('status').innerHTML = '<div class="loading"></div> –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Wi-Fi —Å–µ—Ç–µ–π...';
            
            fetch('/scan')
                .then(response => response.json())
                .then(data => {
                    let select = document.getElementById('ssid');
                    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ Wi-Fi —Å–µ—Ç—å --</option>';
                    
                    if (data.networks && data.networks.length > 0) {
                        data.networks.forEach(network => {
                            let option = document.createElement('option');
                            option.value = network.ssid;
                            
                            let signal = 'üì∂';
                            if (network.rssi > -50) signal = 'üì∂üì∂üì∂';
                            else if (network.rssi > -70) signal = 'üì∂üì∂';
                            
                            let encrypted = network.encryption ? 'üîí' : 'üîì';
                            option.text = `${signal} ${network.ssid} ${encrypted}`;
                            select.appendChild(option);
                        });
                        document.getElementById('status').style.display = 'none';
                    } else {
                        document.getElementById('status').innerHTML = '–°–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                    }
                })
                .catch(error => {
                    document.getElementById('status').innerHTML = '–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ç–µ–π: ' + error;
                });
        }
        
        function validateForm() {
            let ssid = document.getElementById('ssid').value;
            let wifiPass = document.getElementById('wifi_password').value;
            let mqttUser = document.getElementById('mqtt_username').value;
            let mqttPass = document.getElementById('mqtt_password').value;
            
            if (!ssid) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ Wi-Fi —Å–µ—Ç—å');
                return false;
            }
            if (!wifiPass) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å Wi-Fi');
                return false;
            }
            if (!mqttUser) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è MQTT (–ª–æ–≥–∏–Ω Dealgate)');
                return false;
            }
            if (!mqttPass) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å MQTT (–ø–∞—Ä–æ–ª—å Dealgate)');
                return false;
            }
            return true;
        }
        
        window.onload = function() {
            scanNetworks();
        };
    </script>
</head>
<body>
    <div class="container">
        <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–º–ø—ã</h1>
        <p class="info">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Wi-Fi –∏ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Dealgate</p>
        
        <button class="scan-btn" onclick="scanNetworks()">üîÑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å Wi-Fi —Å–µ—Ç–∏</button>
        
        <form action="/save" method="post" onsubmit="return validateForm()">
            <div class="section">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Wi-Fi</h2>
                
                <label for="ssid">–í—ã–±–µ—Ä–∏—Ç–µ Wi-Fi —Å–µ—Ç—å:</label>
                <select id="ssid" name="ssid" required>
                    <option value="">-- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–π --</option>
                </select>
                
                <label for="wifi_password">–ü–∞—Ä–æ–ª—å Wi-Fi:</label>
                <input type="password" id="wifi_password" name="wifi_password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å Wi-Fi" required>
            </div>
            
            <div class="section">
                <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ MQTT (Dealgate)</h2>
                <p class="note">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è <strong>dealgate.ru</strong> ‚Üí —Ä–∞–∑–¥–µ–ª MQTT Server</p>
                
                <label for="mqtt_username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è MQTT:</label>
                <input type="text" id="mqtt_username" name="mqtt_username" placeholder="–í–∞—à –ª–æ–≥–∏–Ω MQTT –æ—Ç Dealgate" required>
                
                <label for="mqtt_password">–ü–∞—Ä–æ–ª—å MQTT:</label>
                <input type="password" id="mqtt_password" name="mqtt_password" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å MQTT –æ—Ç Dealgate" required>
            </div>
            
            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </form>
        
        <div id="status"></div>
    </div>
</body>
</html>